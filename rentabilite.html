<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="robots" content="noindex,nofollow">
<title>PostBus Connect — Analyse rentabilité (interne, saison complète)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0A0B10; --bg-2:#0F1118; --ink:#EDEEF2; --muted:#A7ADBD;
  --brand:#FFD300; --brand-ink:#0B0B0B; --line:#1C2030;
  --card:rgba(255,255,255,.06); --glass:blur(10px) saturate(130%);
  --green:#35E0A1; --red:#FF6B6B; --blue:#7AB2FF;
  --radius:16px; --shadow:0 20px 60px rgba(0,0,0,.35); --max:1180px;
}
*{box-sizing:border-box} html,body{margin:0}
body{background:radial-gradient(900px 650px at 85% -10%,#1B2040 0%,#0B0D14 40%,#07080D 100%) fixed;
     color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.container{width:min(92vw,var(--max));margin:auto}
h1,h2{font-family:"Space Grotesk",Inter,sans-serif;letter-spacing:-.01em}
h1{font-size:clamp(28px,5vw,48px);margin:18px 0}
h2{font-size:clamp(20px,3vw,28px);margin:16px 0 10px}
p,small{color:var(--muted)}
.card{background:var(--card);backdrop-filter:var(--glass);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-end}
.btn{display:inline-flex;gap:8px;align-items:center;padding:12px 14px;border-radius:12px;border:1px solid #2A2F45;background:#151927;color:#fff;font-weight:800;cursor:pointer}
.btn.brand{background:var(--brand);color:#000;border-color:#C7A700}
.btn.ghost{background:#11131B}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#11131B;border:1px solid var(--line);font-weight:800}
.ok{color:#0C5;}.ko{color:#F66}
input,select{width:100%;padding:10px;border:1px solid #2A2F45;border-radius:10px;background:#0E1220;color:#EDEEF2}
input:focus,select:focus{outline:3px solid rgba(122,178,255,.45);outline-offset:2px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
.table{overflow:auto;border-radius:12px;border:1px solid #22283A}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px;background:#0C0F1A}
th,td{padding:10px 10px;border-bottom:1px solid #1B2030;text-align:left;font-size:14px}
th{position:sticky;top:0;background:#0F1323;font-weight:800}
tfoot td{font-weight:800;background:#0F1323}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi .card{display:grid;gap:6px}
.kpi b{font-size:22px}
.tag{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2A2F45;border-radius:999px;background:#11131B}
hr{border:0;height:1px;background:#1E2233;margin:16px 0}
.small{font-size:12px}
.right{text-align:right}
</style>
</head>
<body>
  <div class="container">
    <h1>Analyse rentabilité — PostBus Connect (interne)</h1>
    <p class="badge">Hypothèses : <b>commission Magic Pass = 0% pour l’opérateur</b> (prise en charge par Magic Pass) · <b>Contribution destination = CHF 150</b> / bus (modifiable) · <b>pas de surcharge premium</b>.</p>

    <!-- PARAMÈTRES PAR DÉFAUT -->
    <div class="card">
      <h2>Paramètres par défaut</h2>
      <div class="grid">
        <label>Capacité (places)
          <input id="defCap" type="number" min="1" value="40">
        </label>
        <label>Taux de remplissage (%)
          <input id="defLF" type="number" min="0" max="100" step="1" value="40">
        </label>
        <label>Prix billet (CHF)
          <input id="defFare" type="number" min="0" step="1" value="32">
        </label>
        <label>Coûts variables par bus (CHF)
          <input id="defCost" type="number" min="0" step="1" value="450">
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <label>Contribution destination par bus (CHF)
          <input id="defSubsidy" type="number" min="0" step="1" value="150">
        </label>
        <span class="tag">Commission Magic Pass (opérateur) : 0% — couverte par Magic Pass</span>
        <button class="btn" id="applyDefaults">Appliquer aux nouvelles lignes</button>
      </div>
    </div>

    <!-- OUTILS DE PLANIF -->
    <div class="card" style="margin-top:12px">
      <h2>Planification rapide</h2>
      <div class="row">
        <button class="btn brand" id="addOne">Ajouter 1 ligne</button>
        <button class="btn" id="genSeason">Générer toute la saison (ven–sam–dim : 20.12.2025 → 31.03.2026)</button>
        <button class="btn ghost" id="resetSeason">Effacer & générer saison</button>
        <button class="btn" id="genWeekends">Générer jan–mars 2026 (ven–sam–dim)</button>
        <button class="btn ghost" id="clearAll">Vider le tableau</button>
        <span class="small">Astuce : “Dupliquer” sur une ligne = 2e bus le même jour.</span>
      </div>
    </div>

    <!-- TABLEAU COURSES -->
    <div class="card table" style="margin-top:12px">
      <table id="tbl">
        <thead>
          <tr>
            <th>Date</th>
            <th>Origine</th>
            <th>Destination</th>
            <th>Capacité</th>
            <th>Remplissage %</th>
            <th>Prix billet</th>
            <th>Coûts variables</th>
            <th>Contribution destination</th>
            <th>Pax</th>
            <th>Recettes billets</th>
            <th>Recettes autres</th>
            <th>Revenu total</th>
            <th>Marge / bus</th>
            <th>GO ?</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
        <tfoot>
          <tr>
            <td colspan="8" class="right">Totaux</td>
            <td id="tPax">0</td>
            <td id="tTicket">CHF 0.–</td>
            <td id="tOther">CHF 0.–</td>
            <td id="tRev">CHF 0.–</td>
            <td id="tMargin">CHF 0.–</td>
            <td id="tGo" class="ok">—</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- KPIs SAISON -->
    <div class="kpi" style="margin-top:12px">
      <div class="card">
        <small>Total bus</small>
        <b id="kBus">0</b>
      </div>
      <div class="card">
        <small>Pax saison (est.)</small>
        <b id="kPax">0</b>
      </div>
      <div class="card">
        <small>Marge saison</small>
        <b id="kMargin">CHF 0.–</b>
      </div>
      <div class="card">
        <small>Break-even remplissage (≈)</small>
        <b id="kBE">—</b>
        <small class="small">Capacité & coût moyen actuels</small>
      </div>
    </div>

    <!-- AGRÉGAT PAR DESTINATION -->
    <div class="card" style="margin-top:12px">
      <h2>Par destination</h2>
      <div class="table">
        <table id="byDest">
          <thead>
            <tr><th>Destination</th><th>Bus</th><th>Pax</th><th>Billets</th><th>Contributions</th><th>Coûts</th><th>Marge</th><th>GO ?</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <small class="small">“Contribution destination” est saisie par ligne (défaut <b>CHF 150</b>), modifiable si une station paie plus.</small>
    </div>

    <hr>
    <p class="small">© 2025 MobilityLab — Page interne de simulation. Ajuste les coûts variables selon ton exploitation (carburant, chauffeur, péages, etc.).</p>
  </div>

<script>
/* ===== Utils ===== */
const CHF = (n)=> (isFinite(n)? n.toLocaleString('fr-CH',{style:'currency',currency:'CHF',maximumFractionDigits:0}) : 'CHF 0.–');
const num = (v, fallback=0)=>{ if(typeof v==='number') return v; const s=String(v).trim().replace(/\s/g,'').replace(',','.'); const x=parseFloat(s); return isNaN(x)? fallback : x; };
const clamp = (v, a, b)=> Math.max(a, Math.min(b, v));
const qs=(s,p=document)=>p.querySelector(s);

/* ===== State ===== */
let defaults = { cap: 40, lf: 40, fare: 32, cost: 450, subsidy: 150 };
let rows = []; // {id,date,from,to,cap,lf,fare,cost,subsidy}

/* ===== Storage ===== */
const LS_KEY='pbc_fin_rows_v3';
const LS_DEF='pbc_fin_defs_v3';
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(rows)); localStorage.setItem(LS_DEF, JSON.stringify(defaults)); }
function load(){
  try{ const r=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); if(Array.isArray(r)) rows=r; }catch(e){}
  try{ const d=JSON.parse(localStorage.getItem(LS_DEF)||'{}'); defaults={...defaults, ...d}; }catch(e){}
  qs('#defCap').value = defaults.cap;
  qs('#defLF').value = defaults.lf;
  qs('#defFare').value = defaults.fare;
  qs('#defCost').value = defaults.cost;
  qs('#defSubsidy').value = defaults.subsidy;
}

/* ===== Row Ops ===== */
function addRow(init={}){
  const r = {
    id: crypto.randomUUID(),
    date: init.date || '',
    from: init.from || '',
    to: init.to || '',
    cap: num(init.cap??defaults.cap),
    lf:  num(init.lf??defaults.lf),
    fare: num(init.fare??defaults.fare),
    cost: num(init.cost??defaults.cost),
    subsidy: num(init.subsidy??defaults.subsidy)
  };
  rows.push(r); paint(); save();
}
function removeRow(id){ rows = rows.filter(r=>r.id!==id); paint(); save(); }
function duplicateRow(id){
  const src = rows.find(r=>r.id===id);
  if(!src) return;
  const copy = {...src, id: crypto.randomUUID()};
  rows.push(copy); paint(); save();
}

/* ===== Calculs ===== */
function derive(r){
  const cap = Math.max(0, num(r.cap));
  const lf  = clamp(num(r.lf), 0, 100);
  const pax = Math.round(cap * lf / 100);
  const tickets = pax * Math.max(0, num(r.fare));
  const other   = Math.max(0, num(r.subsidy)); // CHF 150 par défaut, modifiable
  const cost    = Math.max(0, num(r.cost));
  const revenue = tickets + other;
  const margin  = revenue - cost;
  const go      = margin >= 0;
  return {pax, tickets, other, revenue, margin, go};
}

/* ===== Rendering ===== */
function paint(){
  const body = qs('#body'); body.innerHTML='';
  let tPax=0, tTicket=0, tOther=0, tRev=0, tMargin=0;

  rows.forEach(r=>{
    const d = derive(r);
    tPax+=d.pax; tTicket+=d.tickets; tOther+=d.other; tRev+=d.revenue; tMargin+=d.margin;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="date" value="${r.date}" data-k="date"></td>
      <td><input type="text" placeholder="Genève" value="${r.from}" data-k="from"></td>
      <td><input type="text" placeholder="Ovronnaz" value="${r.to}" data-k="to"></td>
      <td><input type="number" min="1" value="${r.cap}" data-k="cap"></td>
      <td><input type="number" min="0" max="100" value="${r.lf}" data-k="lf"></td>
      <td><input type="number" min="0" step="1" value="${r.fare}" data-k="fare"></td>
      <td><input type="number" min="0" step="1" value="${r.cost}" data-k="cost"></td>
      <td><input type="number" min="0" step="1" value="${r.subsidy}" data-k="subsidy"></td>
      <td>${d.pax}</td>
      <td>${CHF(d.tickets)}</td>
      <td>${CHF(d.other)}</td>
      <td>${CHF(d.revenue)}</td>
      <td style="font-weight:800; ${d.margin>=0?'color:#35E0A1':'color:#FF6B6B'}">${CHF(d.margin)}</td>
      <td style="font-weight:800; ${d.go?'color:#35E0A1':'color:#FF6B6B'}">${d.go?'GO':'NO-GO'}</td>
      <td>
        <button class="btn ghost" data-act="dup">Dupliquer</button>
        <button class="btn" data-act="del">Suppr.</button>
      </td>
    `;
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const k = inp.dataset.k;
        if(k==='date'||k==='from'||k==='to'){ r[k]=inp.value; }
        else { r[k]= num(inp.value, r[k]); }
        save(); paint();
      });
    });
    tr.querySelector('[data-act="del"]').addEventListener('click', ()=>removeRow(r.id));
    tr.querySelector('[data-act="dup"]').addEventListener('click', ()=>duplicateRow(r.id));

    body.appendChild(tr);
  });

  // Totaux
  qs('#tPax').textContent = tPax.toLocaleString('fr-CH');
  qs('#tTicket').textContent = CHF(tTicket);
  qs('#tOther').textContent = CHF(tOther);
  qs('#tRev').textContent = CHF(tRev);
  qs('#tMargin').textContent = CHF(tMargin);
  qs('#tGo').textContent = (tMargin>=0)? 'Globalement GO' : 'Globalement NO-GO';
  qs('#tGo').className = (tMargin>=0)? 'ok' : 'ko';

  // KPIs saison
  qs('#kBus').textContent = rows.length;
  qs('#kPax').textContent = tPax.toLocaleString('fr-CH');
  qs('#kMargin').textContent = CHF(tMargin);

  // Break-even (approx) = coût moyen / prix moyen
  const avgCost = rows.length? (rows.reduce((s,r)=>s+num(r.cost),0)/rows.length) : 0;
  const avgFare = rows.length? (rows.reduce((s,r)=>s+num(r.fare),0)/rows.length) : defaults.fare;
  const avgCap  = rows.length? (rows.reduce((s,r)=>s+num(r.cap),0)/rows.length) : defaults.cap;
  let be = '—';
  if(avgFare>0 && avgCap>0){
    const neededPax = avgCost / avgFare;
    const bePct = clamp((neededPax/avgCap)*100,0,200);
    be = `${bePct.toFixed(0)}%`;
  }
  qs('#kBE').textContent = be;

  paintByDestination();
}

function paintByDestination(){
  const tb = qs('#byDest tbody'); tb.innerHTML='';
  const map = new Map();
  rows.forEach(r=>{
    const d = derive(r);
    const key = (r.to||'—').trim() || '—';
    if(!map.has(key)) map.set(key,{bus:0,pax:0,tickets:0,other:0,cost:0,margin:0});
    const ag = map.get(key);
    ag.bus++; ag.pax+=d.pax; ag.tickets+=d.tickets; ag.other+=d.other; ag.cost+=num(r.cost); ag.margin+=d.margin;
  });
  [...map.entries()].sort((a,b)=>a[0].localeCompare(b[0],'fr')).forEach(([dest,ag])=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${dest}</td>
      <td>${ag.bus}</td>
      <td>${ag.pax.toLocaleString('fr-CH')}</td>
      <td>${CHF(ag.tickets)}</td>
      <td>${CHF(ag.other)}</td>
      <td>${CHF(ag.cost)}</td>
      <td style="font-weight:800; ${ag.margin>=0?'color:#35E0A1':'color:#FF6B6B'}">${CHF(ag.margin)}</td>
      <td style="font-weight:800; ${ag.margin>=0?'color:#35E0A1':'color:#FF6B6B'}">${ag.margin>=0?'GO':'NO-GO'}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== Génération week-ends ===== */
const D_SEASON_START = '2025-12-20';
const D_SEASON_END   = '2026-03-31';

function addIfNewDate(iso){
  // on n'ajoute qu'un bus par jour via générateur (mais tu peux dupliquer ensuite)
  if(!rows.some(r=>r.date===iso)) addRow({date: iso});
}

function genByRange(startIso, endIso){
  const start = new Date(startIso + 'T00:00:00');
  const end   = new Date(endIso   + 'T23:59:59');
  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const dow=d.getDay(); // 0=dim … 6=sam
    if(dow===5||dow===6||dow===0){ // ven, sam, dim
      addIfNewDate(d.toISOString().split('T')[0]);
    }
  }
}

function genSeason(){ genByRange(D_SEASON_START, D_SEASON_END); }
function genWeekends(){ genByRange('2026-01-01','2026-03-31'); }

/* ===== Events ===== */
qs('#applyDefaults').addEventListener('click', ()=>{
  defaults.cap = num(qs('#defCap').value, defaults.cap);
  defaults.lf  = num(qs('#defLF').value, defaults.lf);
  defaults.fare= num(qs('#defFare').value, defaults.fare);
  defaults.cost= num(qs('#defCost').value, defaults.cost);
  defaults.subsidy = num(qs('#defSubsidy').value, defaults.subsidy);
  save(); paint();
});
qs('#addOne').addEventListener('click', ()=> addRow({}));
qs('#genSeason').addEventListener('click', genSeason);
qs('#resetSeason').addEventListener('click', ()=>{
  if(confirm('Effacer toutes les lignes puis générer toute la saison ?')){
    rows=[]; paint(); save(); genSeason();
  }
});
qs('#genWeekends').addEventListener('click', genWeekends);
qs('#clearAll').addEventListener('click', ()=>{
  if(confirm('Effacer toutes les lignes ?')){ rows=[]; paint(); save(); }
});

/* ===== Init ===== */
load();
paint();
// Exemple si vide
if(rows.length===0){
  addRow({date:'2025-12-20', from:'Genève', to:'Ovronnaz'});
  addRow({date:'2026-01-03', from:'Lausanne', to:'Leukerbad', lf:45, cost:480});
}
</script>
</body>
</html>