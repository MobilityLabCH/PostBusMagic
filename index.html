<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PostBus Connect â€” Navettes ski (Prototype MobilityLab)</title>
<meta name="description" content="Navettes directes CarPostal (bus confort 40 places). Offre complÃ©mentaire aux transports publics, uniquement sur les axes oÃ¹ la voiture est nettement moins contraignante. RÃ©servation simple, siÃ¨ge premium, mÃ©tÃ©o.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
/* ============ TOKENS ============ */
:root{
  --bg:#0A0B10; --bg-2:#0F1118; --ink:#EDEEF2; --muted:#A7ADBD;
  --brand:#FFD300; --brand-ink:#0B0B0B; --line:#1C2030;
  --card:rgba(255,255,255,.06); --glass:blur(10px) saturate(130%);
  --blue:#7AB2FF; --green:#35E0A1; --red:#FF6B6B; --vio:#7E7CFE;
  --radius:16px; --radius-lg:22px; --shadow:0 20px 60px rgba(0,0,0,.35);
  --max:1180px;
}
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0}
body{
  background:radial-gradient(1000px 700px at 85% -10%,#1B2040 0%,#0B0D14 40%,#07080D 100%) fixed;
  color:var(--ink);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
a{color:inherit;text-decoration:none}
img{max-width:100%;display:block;border-radius:12px}
.container{width:min(92vw,var(--max));margin:auto}
h1{font-family:"Space Grotesk",Inter,sans-serif;letter-spacing:-.02em;font-weight:700;line-height:1.05;
   font-size:clamp(34px,6vw,72px);margin:0 0 6px}
h2{font-family:"Space Grotesk",Inter,sans-serif;font-weight:700;letter-spacing:-.01em;
   font-size:clamp(24px,3vw,36px);margin:0 0 10px}
h3{font-weight:700;margin:6px 0 4px}
p{margin:.3rem 0;color:var(--muted)}
small{color:var(--muted)}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#11131B;border:1px solid var(--line);font-weight:800}
.btn{display:inline-flex;gap:10px;align-items:center;justify-content:center;padding:14px 18px;border-radius:14px;border:1px solid #2A2F45;background:#151927;color:#fff;font-weight:800;transition:transform .12s ease, box-shadow .12s ease}
.btn:hover{transform:translateY(-1px);box-shadow:0 10px 40px rgba(122,178,255,.18)}
.btn.brand{background:var(--brand); color:#000; border-color:#C7A700; box-shadow:0 10px 40px rgba(255,211,0,.25)}
.btn.ghost{background:#11131B}
.tag{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #2A2F45;border-radius:999px;background:#11131B}
.card{background:var(--card);backdrop-filter:var(--glass);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.card-lg{border-radius:var(--radius-lg)}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
@media (max-width:980px){.grid-3,.grid-2{grid-template-columns:1fr}}

/* ============ NAV ============ */
header{position:fixed;inset:0 0 auto 0;z-index:40;background:linear-gradient(180deg,rgba(8,9,15,.85),rgba(8,9,15,.35) 70%,transparent);backdrop-filter:var(--glass);border-bottom:1px solid #141829}
.nav{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
.logo{display:flex;gap:10px;align-items:center;font-weight:800}
.logo .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px rgba(255,211,0,.15)}
nav a{color:#D4DAEA;font-weight:700;margin-left:16px}
nav .cta{margin-left:12px}

/* ============ HERO ============ */
#hero{padding:120px 0 76px;position:relative;overflow:hidden}
#hero .bg{
  position:absolute;inset:-10% -20% auto -20%;height:120vh;
  background:url('images/crans_montana.jpg') center/cover no-repeat;
  filter:contrast(1.05) brightness(.6) saturate(1.1) blur(2px); opacity:.35; z-index:-2;
}
.hero-wrap{display:grid;grid-template-columns:1.15fr .85fr;gap:26px;align-items:center}
.hero-visual{border-radius:18px;overflow:hidden;border:1px solid #20263B}
.hero-visual img{aspect-ratio:4/3;object-fit:cover}
.hero-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:16px}
.kpi{background:#101320;border:1px solid #252B42;border-radius:12px;padding:10px;text-align:center}
.kpi b{font-size:18px}
@media (max-width:980px){
  .hero-wrap{grid-template-columns:1fr}
  .hero-visual{order:-1}
  .hero-kpis{grid-template-columns:repeat(2,1fr)}
}

/* ============ CONTENT ============ */
section{padding:70px 0}
.sub{color:var(--muted);margin-bottom:16px}

/* Steps */
.step{padding:14px}
.step .num{font-family:"Space Grotesk";font-size:32px;color:#9EB8FF}

/* Elegibility chips */
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px dashed #2A2F45;border-radius:999px;padding:6px 10px}

/* FORM */
.form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form .full{grid-column:1/-1}
label{font-weight:800;font-size:.92rem}
select,input[type="date"],input[type="text"],input[type="email"],input[type="number"],input[type="tel"]{width:100%;padding:12px;border:1px solid #2A2F45;border-radius:12px;background:#0E1220;color:#E8EBF7}
select:focus,input:focus{outline:3px solid rgba(122,178,255,.45);outline-offset:2px}
.note{color:var(--muted);font-size:.92rem}

/* Result */
.result{margin-top:14px;display:none}
.row{display:flex;flex-wrap:wrap;justify-content:space-between;gap:10px}
.pr{font-family:"Space Grotesk";font-size:28px;font-weight:800}
.badge.ok{background:#10231C;border:1px solid #29503F;color:#9EF3C9}
.badge.block{background:#2A1010;border:1px solid #5A2A2A;color:#FFB3B3}

/* Seat map 2+2 â€” Iveco midi 40p */
.bus{ --seat:46px; --aisle:28px; display:grid; grid-template-columns:repeat(2,var(--seat)) var(--aisle) repeat(2,var(--seat)); gap:8px; padding:12px; border:1px dashed #2A2F45; border-radius:14px; background:#0F1323; }
.bus-head{grid-column:1/-1;color:#A7ADBD;text-align:center}
.seat{ width:var(--seat); height:var(--seat); display:grid; place-items:center; border-radius:10px; border:1px solid #2A2F45; background:#0B0E1A; color:#D8DEF1; font-weight:800; cursor:pointer; transition:transform .08s ease, border-color .08s ease; }
.seat:hover{transform:translateY(-1px); border-color:#6EA8FF}
.seat.premium{background:linear-gradient(180deg,#2B1F00,#1A1400); color:#FFE89A; border-color:#A08319}
.seat.selected{outline:3px solid #7AB2FF}
.seat.taken{background:#15192A;color:#6E7696;border-style:dashed;cursor:not-allowed}
.legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* Pricing section â€” simplified */
.price-card{padding:22px;text-align:center}
.price-xl{font-family:"Space Grotesk";font-size:42px;font-weight:800}
.tagline{font-size:14px;color:var(--muted)}

/* Map placeholder */
#map{height:420px;border-radius:18px;border:1px solid #232940;background:url('images/nax.jpg') center/cover no-repeat}

/* Footer */
footer{padding:40px 0;border-top:1px solid #171C2B;background:linear-gradient(180deg,#0B0D14,#0A0B10)}
.foot{display:grid;grid-template-columns:2fr 1fr 1fr;gap:18px}
@media (max-width:980px){.foot{grid-template-columns:1fr}}

/* Micro animations (reveal) */
.reveal{opacity:0;transform:translateY(14px);transition:.6s ease}
.reveal.show{opacity:1;transform:none}

/* Sticky mobile CTA */
.sticky{position:fixed;inset:auto 0 0 0;z-index:50;display:flex;gap:10px;justify-content:center;padding:10px;background:rgba(9,11,18,.8);backdrop-filter:var(--glass);border-top:1px solid #151A2A}
.sticky .btn{padding:12px 14px;border-radius:12px}
@media (min-width:861px){.sticky{display:none}}

/* ===== Modal paiement TWINT (prototype) ===== */
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(6,8,14,.7);backdrop-filter:var(--glass);z-index:100}
.modal.show{display:grid}
.modal .panel{width:min(92vw,520px);border-radius:18px;border:1px solid var(--line);background:#0E1220;box-shadow:var(--shadow);padding:18px}
.modal header{position:static;background:none;border:0}
.modal h3{margin-top:0}
.qr-wrap{display:flex;align-items:center;gap:16px}
.qr-box{padding:12px;border:1px dashed #2A2F45;border-radius:12px;background:#0B0E1A}
.hr{height:1px;background:#1E2436;margin:12px 0}

/* Form helper */
.invalid{border-color:#FF6B6B!important; outline-color:rgba(255,107,107,.35)!important}
</style>
</head>
<body>

<header>
  <div class="container nav">
    <div class="logo">
      <span class="dot"></span>
      <span>PostBus Connect</span>
      <span class="badge">Prototype MobilityLab</span>
    </div>
    <nav>
      <a href="#why">Pourquoi</a>
      <a href="#reserve">RÃ©server</a>
      <a href="#pricing">Tarifs</a>
      <a class="btn brand cta" href="#reserve">Planifier</a>
    </nav>
  </div>
</header>

<!-- HERO -->
<section id="hero">
  <div class="bg" aria-hidden="true"></div>
  <div class="container hero-wrap">
    <div>
      <h1>Navettes directes vers les pistes</h1>
      <p class="sub">Un service <b>complÃ©mentaire aux transports publics</b> â€” uniquement sur les axes oÃ¹ la <b>voiture est nettement moins contraignante</b> (temps, correspondances, marche). Autocar confort 40 places <b>2+2</b>.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <a class="btn brand" href="#reserve">RÃ©server maintenant</a>
        <a class="btn ghost" href="#why">Voir pourquoi</a>
      </div>
      <div class="hero-kpis">
        <div class="kpi"><b>Venâ€“Dim</b><br><small>Saison de ski</small></div>
        <div class="kpi"><b>3 bus</b><br><small>CapacitÃ© 40 places</small></div>
        <div class="kpi"><b>DÃ©part matin</b><br><small>Retour fin de journÃ©e</small></div>
        <div class="kpi"><b>SiÃ¨ge premium</b><br><small>rangs 1â€“2</small></div>
      </div>
    </div>
    <div class="hero-visual card card-lg reveal">
      <img src="https://raw.githubusercontent.com/MobilityLabCH/PostBusMagic/refs/heads/main/images/9EA6CBA5-E7CD-4EFC-B792-5156520F993A.png" alt="MontÃ©e vers Ovronnaz">
    </div>
  </div>
</section>

<!-- WHY -->
<section id="why" class="reveal">
  <div class="container">
    <h2>Pourquoi câ€™est mieux quâ€™un trajet en voiture et en transports publicsâ€¦ lÃ  oÃ¹ Ã§a compte</h2>
    <p class="sub">Nous nâ€™ouvrons une ligne que si elle <b>amÃ©liore rÃ©ellement</b> lâ€™expÃ©rience (â‰¥45 min de mieux ou â‰¥2 correspondances Ã©vitÃ©es).</p>
    <div class="grid-3">
      <div class="step card">
        <div class="num">01</div>
        <h3>Temps gagnÃ©</h3>
        <p>Jusquâ€™Ã  <b>2 h de moins</b> sur certains axes (GenÃ¨ve â‡„ Zinal).</p>
      </div>
      <div class="step card">
        <div class="num">02</div>
        <h3>ZÃ©ro friction</h3>
        <p>Sans correspondance, sans marche pÃ©nible avec lâ€™Ã©quipement.</p>
      </div>
      <div class="step card">
        <div class="num">03</div>
        <h3>Impact positif</h3>
        <p>Moins de voitures en vallÃ©e, moins de COâ‚‚ et moins de stress.</p>
      </div>
    </div>
  </div>
</section>

<!-- RESERVE -->
<section id="reserve" class="reveal">
  <div class="container">
    <h2>RÃ©server</h2>
    <p class="sub">Uniquement sur <b>axes Ã©ligibles</b>. DÃ©parts le matin, retours en fin de journÃ©e.</p>

    <div class="card card-lg" style="padding:18px">
      <form class="form" onsubmit="event.preventDefault(); showOptions();">
        <div>
          <label>Ville de dÃ©part</label>
          <select id="from" required>
            <option value="">SÃ©lectionnezâ€¦</option>
            <option>GenÃ¨ve</option>
            <option>Lausanne</option>
            <option>Yverdon</option>
            <option>Fribourg</option>
          </select>
        </div>
        <div>
          <label>Date (uniquement si service)</label>
          <select id="date" required>
            <option value="">Choisir une dateâ€¦</option>
          </select>
        </div>
        <div>
          <label>Station (selon la date)</label>
          <select id="to" required>
            <option value="">SÃ©lectionnezâ€¦</option>
          </select>
        </div>
        <div>
          <label>Forfait 5 A/R</label>
          <select id="pack">
            <option value="no">Non</option>
            <option value="yes">Oui (CHF 100)</option>
          </select>
        </div>
        <div class="full" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn brand" type="submit">Voir les dÃ©parts</button>
          <span class="tag">Uniquement durant la saison de ski</span>
          <span class="tag">RÃ©servÃ© aux dÃ©tenteurs dâ€™un Magic Pass</span>
        </div>
      </form>

      <div class="result" id="result">
        <div class="row">
          <div>
            <b id="r-route">â€”</b><br>
            <small id="r-times">â€”</small><br>
            <span id="eligBadge" class="badge">â€”</span>
            <div id="eligWhy" class="note" style="margin-top:6px">â€”</div>
            <div class="tag" id="seatCount" style="margin-top:8px">â€” places restantes</div>
          </div>
          <div style="text-align:right">
            <small>Prix</small><br>
            <div class="pr" id="r-price">â€”</div>
            <div class="tagline" id="r-price-note">Tarifs simples</div>
          </div>
        </div>

        <!-- Seat map -->
        <div class="card" style="margin-top:14px;padding:14px">
          <h3 style="margin:4px 0 10px">Choisir un siÃ¨ge</h3>
          <div class="legend">
            <span class="tag">Rangs 1â€“2 = premium (+CHF 5)</span>
            <span class="tag" id="seatChosen">Aucun siÃ¨ge</span>
          </div>
          <div style="margin-top:12px">
            <div class="bus" id="seatmap" role="grid" aria-label="Plan 2+2, 10 rangÃ©es"></div>
          </div>
        </div>

        <!-- CoordonnÃ©es passager -->
        <div class="card" style="margin-top:14px;padding:14px">
          <h3 style="margin:4px 0 10px">CoordonnÃ©es passager</h3>
          <div class="form">
            <div>
              <label>PrÃ©nom</label>
              <input id="i-first" type="text" placeholder="PrÃ©nom" autocomplete="given-name">
            </div>
            <div>
              <label>Nom</label>
              <input id="i-last" type="text" placeholder="Nom" autocomplete="family-name">
            </div>
            <div>
              <label>WhatsApp / Mobile</label>
              <input id="i-wa" type="tel" inputmode="tel" placeholder="+41 â€¦" autocomplete="tel">
            </div>
            <div>
              <label>E-mail</label>
              <input id="i-mail" type="email" placeholder="nom@exemple.ch" autocomplete="email">
            </div>
            <div>
              <label>Ã‚ge</label>
              <input id="i-age" type="number" min="0" max="120" step="1" placeholder="18">
            </div>
            <div class="full" style="display:flex;gap:10px;align-items:center">
              <input id="i-terms" type="checkbox" style="width:auto">
              <label for="i-terms">Jâ€™accepte les conditions et la protection des donnÃ©es</label>
            </div>
          </div>
          <small class="note">Les donnÃ©es sont utilisÃ©es uniquement pour lâ€™exploitation du service (contact opÃ©rationnel, sÃ©curitÃ©). Aucune vente Ã  des tiers.</small>
        </div>

        <div class="row" style="margin-top:14px">
          <small class="note">Demi-tarif non valable (produit spÃ©cifique CarPostal).</small>
          <button class="btn brand" onclick="pay()">Payer avec TWINT</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- PRICING (simplifiÃ©) -->
<section id="pricing" class="reveal">
  <div class="container">
    <h2>Tarifs simples & lisibles</h2>
    <p class="sub">Pas de surprise : un prix clair, une option premium, un pack valable toute la saison.</p>
    <div class="grid-3">
      <div class="card price-card">
        <div class="tag">Trajet A/R</div>
        <div class="price-xl">CHF <span id="priceFrom">25</span>.â€“</div>
        <p class="tagline">Early (â‰¥ 10 jours) : 25.â€“ Â· Standard : 32.â€“ Â· Last minute : 39.â€“</p>
      </div>
      <div class="card price-card">
        <div class="tag">SiÃ¨ge Premium</div>
        <div class="price-xl">+ CHF 5.â€“</div>
        <p class="tagline">Rangs 1â€“2 Â· plus dâ€™espace Â· avant du bus</p>
      </div>
      <div class="card price-card">
        <div class="tag">Pack 5 A/R</div>
        <div class="price-xl">CHF 100.â€“</div>
        <p class="tagline">Soit 20.â€“ par A/R Â· utilisable sur tous les axes Ã©ligibles</p>
      </div>
    </div>
  </div>
</section>

<!-- MAP & METEO -->
<section class="reveal">
  <div class="container">
    <h2>Axes Ã©ligibles</h2>
    <p class="sub">Nous limitons la vente aux corridors oÃ¹ lâ€™expÃ©rience est <b>vraiment meilleure</b> que les transports publics</p>
    <div id="map" class="card card-lg" role="img" aria-label="Carte des liaisons"></div>
    <div class="chips" style="margin-top:12px">
      <span class="chip">GenÃ¨ve â‡„ Zinal Â· TP ~4h24 Â· VÃ©hicule ~2h27</span>
      <span class="chip">GenÃ¨ve â‡„ Ovronnaz Â· TP ~3h35 Â· VÃ©hicule ~1h59</span>
      <span class="chip">Lausanne â‡„ Ovronnaz Â· TP ~2h42 Â· VÃ©hicule ~1h06â€“1h12</span>
      <span class="chip">Lausanne â‡„ Leukerbad Â· TP ~2h17 Â· VÃ©hicule ~1h32</span>
      <span class="chip">Lausanne â‡„ Saas-Fee Â· TP ~3h30 Â· VÃ©hicule ~2h20</span>
      <span class="chip">Lausanne â‡„ Belalp Â· TP ~3h10 Â· VÃ©hicule ~2h05</span>
      <span class="chip">Lausanne â‡„ LÃ¶tschental Â· TP ~2h40 Â· VÃ©hicule ~1h40</span>
      <span class="chip">Fribourg â‡„ Adelboden Â· TP ~2h35 Â· VÃ©hicule ~1h40</span>
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer>
  <div class="container foot">
    <div>
      <h3>PostBus Connect</h3>
      <p>Â© 2025 MobilityLab by Eric â€” Prototype en bÃªta. Offre <b>complÃ©mentaire</b> aux transports publics.</p>
    </div>
    <div>
      <h3>Navigation</h3>
      <p><a href="#reserve">RÃ©server</a><br><a href="#pricing">Tarifs</a><br><a href="#why">Pourquoi</a></p>
    </div>
    <div>
      <h3>Contact</h3>
      <p><a href="#">Mentions</a> Â· <a href="#">Conditions</a> Â· <a href="#">ConfidentialitÃ©</a></p>
    </div>
  </div>
</footer>

<!-- Sticky mobile CTA -->
<div class="sticky">
  <a class="btn brand" href="#reserve">Planifier</a>
  <a class="btn" href="#pricing">Tarifs</a>
</div>

<!-- ======== Paiement modal (TWINT fictif) ======== -->
<div id="payModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
  <div class="panel">
    <h3 id="payTitle">Paiement TWINT (prototype)</h3>
    <div class="qr-wrap">
      <div class="qr-box">
        <canvas id="twintQR" width="220" height="220" aria-label="QR TWINT"></canvas>
      </div>
      <div>
        <b id="m-amount">â€”</b><br>
        <small id="m-ref" class="note">RÃ©fÃ©rence â€”</small>
        <div class="hr"></div>
        <small class="note">Scanne le QR avec TWINT.<br>Sinon, pour tester :</small><br>
        <button class="btn brand" id="btnSimulate">Paiement simulÃ©</button>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px">
      <button class="btn" onclick="closePayModal()">Annuler</button>
    </div>
  </div>
</div>

<!-- Libs (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- ==== CONFIG (ton QR + auto-PDF + CO2) ==== -->
<script>
  const CUSTOM_QR_SRC = 'images/bing_generated_qrcode.png'; // ton QR uploadÃ©
  const AUTO_SIMULATE = true;                               // PDF auto aprÃ¨s "Payer"
  const EF_CAR_G_PER_KM   = 171;                            // gCO2/km voiture
  const EF_COACH_G_PER_KM = 27;                             // gCO2/km autocar
  const AVG_SPEED_KM_PER_MIN = 1.0;                         // ~60 km/h
</script>

<script>
/* ========= UX: reveal on scroll ========= */
const obs=new IntersectionObserver((entries)=>entries.forEach(e=>{if(e.isIntersecting)e.target.classList.add('show')}),{threshold:.08});
document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));

/* ========= Ã‰LIGIBILITÃ‰ ========= */
const ELIGIBILITY={
  "GenÃ¨ve â‡„ Zinal": {eligible:true, reason:"TP ~4h24 (plusieurs changements) Â· vÃ©hicule ~2h27 (gain ~2h)."},
  "GenÃ¨ve â‡„ Ovronnaz": {eligible:true, reason:"TP ~3h35 Â· vÃ©hicule ~1h59 (gain ~1h35)."},
  "GenÃ¨ve â‡„ Saas-Fee": {eligible:true, reason:"TP ~4h00â€“4h15 Â· vÃ©hicule ~2h45 (gain ~1h15â€“1h30)."},
  "GenÃ¨ve â‡„ Belalp": {eligible:true, reason:"TP ~3h50 Â· vÃ©hicule ~2h35 (gain ~1h15)."},
  "GenÃ¨ve â‡„ Grimentz/St-Luc": {eligible:true, reason:"TP ~3h45â€“4h00 Â· vÃ©hicule ~2h30 (gain ~1h15+)."},
  "GenÃ¨ve â‡„ EvolÃ¨ne/Arolla": {eligible:true, reason:"TP ~4h00â€“4h20 Â· vÃ©hicule ~2h35 (gain ~1h25)."},
  "GenÃ¨ve â‡„ Thyon 2000": {eligible:true, reason:"TP ~3h45 Â· vÃ©hicule ~2h20 (gain ~1h25)."},

  "Lausanne â‡„ Ovronnaz": {eligible:true, reason:"TP ~2h42 via Riddes/Leytron Â· vÃ©hicule 1h06â€“1h12 (gain ~1h30)."},
  "Lausanne â‡„ Leukerbad": {eligible:true, reason:"TP ~2h17 (train + bus) Â· vÃ©hicule ~1h32 (gain ~45 min)."},
  "Lausanne â‡„ LÃ¶tschental": {eligible:true, reason:"TP ~2h40 (train+bus via Goppenstein) Â· vÃ©hicule ~1h40 (gain ~1h)."},
  "Lausanne â‡„ Saas-Fee": {eligible:true, reason:"TP ~3h30 Â· vÃ©hicule ~2h20 (gain ~1h10)."},
  "Lausanne â‡„ Belalp": {eligible:true, reason:"TP ~3h10 Â· vÃ©hicule ~2h05 (gain ~1h05)."},
  "Lausanne â‡„ Grimentz/St-Luc": {eligible:true, reason:"TP ~3h20 Â· vÃ©hicule ~2h05 (gain ~1h15)."},
  "Lausanne â‡„ EvolÃ¨ne/Arolla": {eligible:true, reason:"TP ~3h30 Â· vÃ©hicule ~2h05 (gain ~1h25)."},
  "Lausanne â‡„ Thyon 2000": {eligible:true, reason:"TP ~3h15 Â· vÃ©hicule ~1h50 (gain ~1h25)."},
  "Lausanne â‡„ Gstaad": {eligible:false, reason:"Ã‰cart limite : TP ~2h15 vs vÃ©hicule ~1h30 (gain ~45 min, 1â€“2 correspondances)."},

  "Yverdon â‡„ Ovronnaz": {eligible:true, reason:"TP ~2h45 Â· vÃ©hicule ~1h35 (gain ~1h10)."},
  "Yverdon â‡„ Leukerbad": {eligible:true, reason:"TP ~3h05 Â· vÃ©hicule ~1h55 (gain ~1h10)."},
  "Yverdon â‡„ LÃ¶tschental": {eligible:true, reason:"TP ~3h00 Â· vÃ©hicule ~1h50 (gain ~1h10)."},
  "Yverdon â‡„ Belalp": {eligible:true, reason:"TP ~3h20 Â· vÃ©hicule ~2h10 (gain ~1h10)."},

  "Fribourg â‡„ Zinal": {eligible:true, reason:"TP ~3h50 Â· vÃ©hicule ~2h30 (gain ~1h20)."},
  "Fribourg â‡„ Saas-Fee": {eligible:true, reason:"TP ~4h05 Â· vÃ©hicule ~2h40 (gain ~1h25)."},
  "Fribourg â‡„ Belalp": {eligible:true, reason:"TP ~3h40 Â· vÃ©hicule ~2h20 (gain ~1h20)."},
  "Fribourg â‡„ Adelboden": {eligible:true, reason:"TP ~2h35 (train+bus) Â· vÃ©hicule ~1h40 (gain ~55 min)."},
  "Fribourg â‡„ Gstaad": {eligible:false, reason:"Ã‰cart limite : TP ~2h00â€“2h10 vs vÃ©hicule ~1h20â€“1h30."},

  "Lausanne â‡„ Les Diablerets": {eligible:false, reason:"TP efficaces ~1h20â€“1h30 vs vÃ©hicule ~1h15."},
  "Lausanne â‡„ Leysin": {eligible:false, reason:"TP trÃ¨s performants (~1h20) vs vÃ©hicule ~1h."},
  "GenÃ¨ve â‡„ AnzÃ¨re": {eligible:false, reason:"Axe bien desservi par TP depuis Sion (bus direct)."}
};

/* ========= Offre ========= */
const CITY_POOLS={
  "GenÃ¨ve":["Zinal","Ovronnaz","Saas-Fee","Belalp","Grimentz/St-Luc","EvolÃ¨ne/Arolla","Thyon 2000"],
  "Lausanne":["Ovronnaz","Leukerbad","LÃ¶tschental","Saas-Fee","Belalp","Grimentz/St-Luc","EvolÃ¨ne/Arolla","Thyon 2000"],
  "Yverdon":["Ovronnaz","Leukerbad","LÃ¶tschental","Belalp"],
  "Fribourg":["Zinal","Saas-Fee","Belalp","Adelboden"]
};
const SEASON={start:"2025-12-05", end:"2026-03-15"};

function isWeekend(d){const g=d.getDay();return g===5||g===6||g===0;}
function inSeason(d){return d>=new Date(SEASON.start+"T00:00:00") && d<=new Date(SEASON.end+"T23:59:59");}
function hashDate(dateStr){const d=dateStr.replaceAll('-','');let h=0;for(const ch of d){h=(h*33 + ch.charCodeAt(0))%997;}return h;}
function servicesForDate(dateStr){
  const h=hashDate(dateStr);
  const thirdCity= (h%2===0) ? "Fribourg" : "Yverdon";
  const cities=["GenÃ¨ve","Lausanne", thirdCity];
  const depSlots={"GenÃ¨ve":"06:30","Lausanne":"07:00","Yverdon":"07:10","Fribourg":"06:45"};
  const retSlots={"GenÃ¨ve":"16:45","Lausanne":"17:00","Yverdon":"16:30","Fribourg":"16:40"};
  return cities.map((city,idx)=>{
    const pool=CITY_POOLS[city];
    const to=pool[(h+idx)%pool.length];
    return {from:city, to, dep:depSlots[city], ret:retSlots[city]};
  });
}
function nextServiceDates(){
  const res=[]; const today=new Date();
  for(let i=0;i<16*7;i++){
    const d=new Date(today.getTime()+i*86400000);
    if(!isWeekend(d)||!inSeason(d)) continue;
    res.push(d.toISOString().split('T')[0]);
  }
  return res;
}

/* ========= Pricing ========= */
function basePrice(dateStr){
  const d=new Date(dateStr+"T12:00:00"), now=new Date();
  const days=Math.ceil((d-now)/86400000);
  if(days>=10) return 25; if(days>=4) return 32; return 39;
}
function CHF(n){return "CHF "+n.toFixed(0)+".â€“";}

/* ========= DurÃ©e route (Ã  partir du texte 'vÃ©hicule ...') ========= */
function minutes(h,m){return (parseInt(h,10)||0)*60 + (parseInt(m,10)||0);}
function rideMinutes(from,to){
  const meta=ELIGIBILITY[`${from} â‡„ ${to}`];
  if(!meta) return 120;
  const s=meta.reason;
  const part = (s.split("vÃ©hicule")[1] || s);
  let r = part.match(/(\d{1,2})h(\d{1,2})\s*[â€“-]\s*(\d{1,2})h(\d{1,2})/);
  if(r){ const a=minutes(r[1],r[2]), b=minutes(r[3],r[4]); return Math.round((a+b)/2); }
  r = part.match(/~?\s*(\d{1,2})h(\d{1,2})/);
  if(r){ return minutes(r[1],r[2]); }
  return 120;
}
function addMinutesToTime(hhmm, mins){
  const [h,m]=hhmm.split(':').map(Number);
  const t=(h*60+m+mins);
  const H=((Math.floor((t/60))%24)+24)%24, M=((t%60)+60)%60;
  return `${String(H).padStart(2,'0')}:${String(M).padStart(2,'0')}`;
}

/* ========= State ========= */
const fromSel=document.getElementById('from');
const dateSel=document.getElementById('date');
const toSel=document.getElementById('to');
let CURRENT_SERVICE=null;
let TAKEN_SEATS=new Set();

/* ========= UI populate ========= */
fromSel.addEventListener('change',()=>{ populateDates(); toSel.innerHTML='<option value="">SÃ©lectionnezâ€¦</option>'; });
dateSel.addEventListener('change',()=>{ populateDestination(); });

function populateDates(){
  dateSel.innerHTML='<option value="">Choisir une dateâ€¦</option>';
  const city=fromSel.value; if(!city) return;
  for(const iso of nextServiceDates()){
    const services=servicesForDate(iso);
    if(services.some(s=>s.from===city)){
      const opt=document.createElement('option');
      opt.value=iso; opt.textContent=new Date(iso).toLocaleDateString('fr-CH', {weekday:'short', day:'2-digit', month:'2-digit'});
      dateSel.appendChild(opt);
    }
  }
}
function populateDestination(){
  toSel.innerHTML='<option value="">SÃ©lectionnezâ€¦</option>';
  const city=fromSel.value, iso=dateSel.value; if(!city||!iso) return;
  const service=servicesForDate(iso).find(s=>s.from===city);
  if(service){
    const opt=document.createElement('option');
    opt.value=service.to; opt.textContent=service.to; toSel.appendChild(opt); toSel.value=service.to;
    const duration = rideMinutes(city, service.to);
    CURRENT_SERVICE={date:iso, ...service, duration};
  }
}
function isWeekendISO(iso){return isWeekend(new Date(iso+"T00:00:00"));}

function showOptions(){
  const from=fromSel.value.trim(), to=toSel.value.trim(), date=dateSel.value, pack=document.getElementById('pack').value;
  if(!from||!to||!date){alert("ComplÃ¨te tous les champs.");return;}
  const svc=servicesForDate(date).find(s=>s.from===from && s.to===to);
  if(!svc || !isWeekendISO(date)) { alert("Pas de service ce jour-lÃ  pour cette ville."); return; }

  const duration = rideMinutes(from, to);
  CURRENT_SERVICE={date, ...svc, duration};
  seedTakenSeats();

  const key=`${from} â‡„ ${to}`;
  const meta=ELIGIBILITY[key] || {eligible:false, reason:"Axe bien desservi par les transports publics â€” on recommande les transports publics."};
  document.getElementById('r-route').textContent = `${from} â†’ ${to}`;

  const arrStation = addMinutesToTime(svc.dep, duration);
  const arrOrigin  = addMinutesToTime(svc.ret, duration);
  const go  = `DÃ©part ${from} ${svc.dep} â†’ ArrivÃ©e station ${arrStation}`;
  const back= `Retour station ${svc.ret} â†’ ArrivÃ©e ${from} ${arrOrigin}`;
  document.getElementById('r-times').textContent = `${go} â€” ${back}`;
  document.getElementById('eligWhy').textContent = meta.reason;

  const badge=document.getElementById('eligBadge');
  if(!meta.eligible){
    badge.className="badge block"; badge.textContent="Non Ã©ligible â€” privilÃ©gier les TP";
    document.getElementById('result').style.display="block";
    document.getElementById('r-price').textContent="â€”";
    return;
  }else{
    badge.className="badge ok"; badge.textContent="ComplÃ©ment aux TP";
  }

  let price = (pack==="yes") ? 20 : basePrice(date);
  window.__basePrice = price; updatePrice();

  updateSeatCount();
  buildSeats();
  document.getElementById('result').style.display="block";
}

function updatePrice(){
  const premium = document.querySelector('.seat.selected')?.classList.contains('premium') ? 5 : 0;
  const total = (window.__basePrice||0) + premium;
  window.__totalPrice = total;
  document.getElementById('r-price').textContent = CHF(total);
  document.getElementById('r-price-note').textContent = (window.__basePrice===20) ? "Forfait: 20.â€“ / A-R" : "Early 25.â€“ Â· Standard 32.â€“ Â· Last 39.â€“";
}

/* ========= Seats mock ========= */
function seatId(r,c){return `${r}${String.fromCharCode(64+c)}`;}
function seedTakenSeats(){
  const seed=(CURRENT_SERVICE.date+CURRENT_SERVICE.from+CURRENT_SERVICE.to).split('').reduce((a,ch)=>a+ch.charCodeAt(0),0);
  const rand=()=>{const x=Math.sin(seed + (Math.random()*10)) * 10000; return x - Math.floor(x);}
  TAKEN_SEATS=new Set();
  const occupancy= Math.floor(8 + (rand()*16));
  while(TAKEN_SEATS.size<occupancy){
    const r=Math.floor(rand()*10)+1; const c=Math.floor(rand()*4)+1; TAKEN_SEATS.add(seatId(r,c));
  }
}
function updateSeatCount(){
  const left=40 - TAKEN_SEATS.size - (document.querySelector('.seat.selected')?1:0);
  document.getElementById('seatCount').textContent = `${left} places restantes`;
}
function buildSeats(){
  const wrap=document.getElementById('seatmap'); wrap.innerHTML='';
  const head=document.createElement('div');
  head.textContent=`Avant â€¢ ${CURRENT_SERVICE.from}â†’${CURRENT_SERVICE.to} â€¢ ${new Date(CURRENT_SERVICE.date).toLocaleDateString('fr-CH',{weekday:'short', day:'2-digit', month:'2-digit'})}`;
  head.className="bus-head"; wrap.appendChild(head);
  const grid=document.createElement('div'); grid.className="bus";
  for(let r=1;r<=10;r++){
    for(let c=1;c<=2;c++) grid.appendChild(makeSeatButton(r,c));
    const spacer=document.createElement('div'); spacer.style.width="28px"; spacer.style.height="1px"; grid.appendChild(spacer);
    for(let c=3;c<=4;c++) grid.appendChild(makeSeatButton(r,c));
  }
  wrap.appendChild(grid);
}
function makeSeatButton(r,c){
  const id=seatId(r,c);
  const b=document.createElement('button'); b.type="button"; b.className="seat"+(r<=2?" premium":""); b.textContent=id;
  if(TAKEN_SEATS.has(id)){ b.classList.add('taken'); b.disabled=true; }
  b.onclick=()=>selectSeat(b,id);
  return b;
}
function selectSeat(btn,id){
  document.querySelectorAll('.seat').forEach(s=>s.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('seatChosen').textContent = `SiÃ¨ge ${id}` + (btn.classList.contains('premium') ? " Â· premium" : "");
  updatePrice(); updateSeatCount();
}

/* ========= Pay (TWINT fictif) + PDF ========= */
function pay(){
  if(!CURRENT_SERVICE){alert('SÃ©lectionne une course.'); return;}
  const seat=document.querySelector('.seat.selected')?.textContent;
  if(!seat){ alert('Choisis un siÃ¨ge.'); return; }

  // CoordonnÃ©es & validations
  const f=document.getElementById('i-first'), l=document.getElementById('i-last'),
        wa=document.getElementById('i-wa'), em=document.getElementById('i-mail'),
        ag=document.getElementById('i-age'), tc=document.getElementById('i-terms');
  [f,l,wa,em,ag].forEach(x=>x.classList.remove('invalid'));
  let ok=true;
  if(!f.value.trim()){f.classList.add('invalid'); ok=false;}
  if(!l.value.trim()){l.classList.add('invalid'); ok=false;}
  if(!/^\+?\d[\d\s\-()]{7,}$/.test(wa.value.trim())){wa.classList.add('invalid'); ok=false;}
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em.value.trim())){em.classList.add('invalid'); ok=false;}
  const ageNum = parseInt(ag.value, 10);
  if(isNaN(ageNum)){ag.classList.add('invalid'); ok=false;}
  if(!tc.checked){alert("Merci dâ€™accepter les conditions."); ok=false;}
  if(!ok) return;
  if(ageNum < 10){ alert("DÃ©solÃ©, pas possible pour les < 10 ans."); return; }
  const ageLabel = (ageNum < 18) ? "<18" : "â‰¥18";

  const total=window.__totalPrice||0;
  const ref = `PBC-${CURRENT_SERVICE.date.replaceAll('-','')}-${CURRENT_SERVICE.from.slice(0,2).toUpperCase()}-${CURRENT_SERVICE.to.split(/[ /]/)[0].toUpperCase()}-${seat}`;
  const payload = {
    scheme:"TWINT-PBC-DEMO",
    merchant:"PostBus Connect (Prototype)",
    currency:"CHF",
    amount: total,
    reference: ref,
    route: `${CURRENT_SERVICE.from}â†’${CURRENT_SERVICE.to}`,
    date: CURRENT_SERVICE.date,
    dep: CURRENT_SERVICE.dep,
    ret: CURRENT_SERVICE.ret,
    seat
  };

  // Modal + QR
  document.getElementById('m-amount').textContent = CHF(total);
  document.getElementById('m-ref').textContent = `RÃ©fÃ©rence ${ref}`;
  openPayModal();

  const canvas = document.getElementById('twintQR');
  if (CUSTOM_QR_SRC) {
    const img = new Image();
    img.onload = () => {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      const s = Math.min(canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, s, s);
    };
    img.src = CUSTOM_QR_SRC;
  } else {
    try { QRCode.toCanvas(canvas, JSON.stringify(payload), {width:220, errorCorrectionLevel:'M'}); }
    catch(e){ console.warn(e); }
  }

  const customerPayload = {
    first:f.value.trim(), last:l.value.trim(),
    wa:wa.value.trim(),   mail:em.value.trim(),
    age:ageNum, ageLabel
  };

  if (AUTO_SIMULATE) {
    setTimeout(() => onPaymentSuccess(payload, customerPayload), 500);
  }
  document.getElementById('btnSimulate').onclick = () => onPaymentSuccess(payload, customerPayload);
}
function openPayModal(){ document.getElementById('payModal').classList.add('show'); }
function closePayModal(){ document.getElementById('payModal').classList.remove('show'); }

function onPaymentSuccess(qrPayload, customer){
  closePayModal();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const pad=36;

  // Header
  doc.setFont('helvetica','bold'); doc.setFontSize(18);
  doc.text('PostBus Connect â€” Billet / ReÃ§u (prototype)', pad, 54);
  doc.setFontSize(11); doc.setFont('helvetica','normal');
  doc.text('Merci pour votre rÃ©servation !', pad, 74);

  // Trajet
  let y=110;
  doc.setFont('helvetica','bold'); doc.text('Trajet', pad, y); doc.setFont('helvetica','normal'); y+=18;
  const dur = CURRENT_SERVICE.duration || 0;
  const arrStation = addMinutesToTime(CURRENT_SERVICE.dep, dur);
  const arrOrigin  = addMinutesToTime(CURRENT_SERVICE.ret, dur);

  // Estimation distance & CO2
  const oneWayKm = Math.round(dur * AVG_SPEED_KM_PER_MIN);
  const roundTripKm = oneWayKm * 2;
  const carCO2_g   = roundTripKm * EF_CAR_G_PER_KM;
  const coachCO2_g = roundTripKm * EF_COACH_G_PER_KM;
  const saved_g    = Math.max(0, carCO2_g - coachCO2_g);
  const saved_kg   = (saved_g / 1000).toFixed(1);

  const lines = [
    `Date : ${new Date(CURRENT_SERVICE.date).toLocaleDateString('fr-CH')}`,
    `Route : ${CURRENT_SERVICE.from} â†’ ${CURRENT_SERVICE.to}`,
    `Aller : dÃ©part ${CURRENT_SERVICE.dep} â†’ arrivÃ©e station ${arrStation} (â‰ˆ ${dur} min)`,
    `Retour : dÃ©part station ${CURRENT_SERVICE.ret} â†’ arrivÃ©e ${CURRENT_SERVICE.from} ${arrOrigin} (â‰ˆ ${dur} min)`,
    `SiÃ¨ge : ${document.querySelector('.seat.selected')?.textContent || ''}${document.querySelector('.seat.selected')?.classList.contains('premium')?' Â· premium':''}`,
    `Montant : ${CHF(window.__totalPrice||0)}`,
    `Distance estimÃ©e A/R : ~${roundTripKm} km`,
    `COâ‚‚ Ã©vitÃ© vs voiture : â‰ˆ ${saved_kg} kg`
  ];
  lines.forEach(t=>{doc.text(t, pad, y); y+=16;});

  // Passager
  y+=8; doc.setFont('helvetica','bold'); doc.text('Passager', pad, y); doc.setFont('helvetica','normal'); y+=18;
  const clines=[
    `Nom : ${customer.first} ${customer.last}`,
    `Ã‚ge : ${customer.age} ans (${customer.ageLabel})`,
    `WhatsApp / Mobile : ${customer.wa}`,
    `E-mail : ${customer.mail}`,
    `RÃ©fÃ©rence : ${qrPayload.reference}`
  ];
  clines.forEach(t=>{doc.text(t, pad, y); y+=16;});

  // QR
  const canvas=document.getElementById('twintQR');
  try{ const dataURL=canvas.toDataURL('image/png'); doc.addImage(dataURL, 'PNG', 370, 110, 180, 180); }catch(e){}

  // Contact / assistance
  y = 320;
  doc.setDrawColor(220); doc.line(pad, y, 559, y); y+=18;
  doc.setFont('helvetica','bold'); doc.text('Contact & assistance', pad, y); doc.setFont('helvetica','normal'); y+=16;
  doc.text('Eric Imstepf Â· +41 79 46 46 443', pad, y); y+=16;
  doc.text('Ce document fait foi de billet (prototype). PrÃ©sentez le QR et une piÃ¨ce dâ€™identitÃ© au chauffeur.', pad, y); y+=16;
  doc.text('TWINT affichÃ© ici est une simulation pour design/UX. En prod, le paiement est capturÃ© cÃ´tÃ© PSP.', pad, y);

  // Clin dâ€™Å“il
  y += 10;
  doc.setDrawColor(220); doc.line(pad, y, 559, y); y += 18;
  doc.setFont('helvetica','bold'); doc.text('Clin dâ€™Å“il', pad, y);
  doc.setFont('helvetica','normal'); y += 16;
  doc.text('Ce billet nâ€™Ã©met que des sourires (et un soupÃ§on de pixels). Bon ride ! ðŸ˜Ž', pad, y);

  // Footer
  doc.setFontSize(9);
  doc.text('Â© 2025 MobilityLab â€” PostBus Connect (prototype) Â· Offre complÃ©mentaire aux TP', pad, 812);

  const filename=`PostBusConnect_${qrPayload.reference}.pdf`;
  doc.save(filename);
}

/* ========= Pay modal closing ========= */
document.getElementById('payModal').addEventListener('click', (e)=>{
  if(e.target.id==='payModal') closePayModal();
});
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePayModal(); });
</script>
</body>
</html>
